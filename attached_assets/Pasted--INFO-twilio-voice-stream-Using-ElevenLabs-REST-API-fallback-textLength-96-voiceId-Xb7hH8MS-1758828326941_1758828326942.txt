[INFO] [twilio-voice-stream] Using ElevenLabs REST API fallback {"textLength":96,"voiceId":"Xb7hH8MSUJpSbSDYk0k2"}
[DEBUG] [twilio-voice-stream] OpenAI response received {"hasResponse":true,"responseLength":96,"usage":{"prompt_tokens":66,"completion_tokens":20,"total_tokens":86,"prompt_tokens_details":{"cached_tokens":0,"audio_tokens":0},"completion_tokens_details":{"reasoning_tokens":0,"audio_tokens":0,"accepted_prediction_tokens":0,"rejected_prediction_tokens":0}}}
[INFO] [twilio-voice-stream] Deferring cleanup - ElevenLabs is still streaming audio
[INFO] [twilio-voice-stream] WebSocket connection closed
[INFO] [twilio-voice-stream] Cleanup requested {"hasGreeted":true,"conversationLength":3,"isReady":true,"sessionDuration":7420,"totalFramesSent":657,"totalFramesReceived":315,"isElevenLabsStreaming":true}
[DEBUG] [twilio-voice-stream] OpenAI chat request {"model":"gpt-4o-mini","messageCount":4,"maxTokens":150,"temperature":0.7}
[DEBUG] [twilio-voice-stream] Whisper transcription result {"hasText":true,"textLength":3}
[INFO] [twilio-voice-stream] Transcription completed {"transcript":"You","transcriptLength":3}
[INFO] [twilio-voice-stream] Deferring cleanup - ElevenLabs is still streaming audio
[INFO] [twilio-voice-stream] Call ended - stop event received
[INFO] [twilio-voice-stream] Cleanup requested {"hasGreeted":true,"conversationLength":2,"isReady":true,"sessionDuration":6314,"totalFramesSent":657,"totalFramesReceived":315,"isElevenLabsStreaming":true}
[INFO] [twilio-voice-stream] Processing user speech {"bufferLength":16,"durationMs":320}
[DEBUG] [twilio-voice-stream] Starting Whisper transcription {"audioSize":5164,"model":"whisper-1"}
[DEBUG] [twilio-voice-stream] Incoming audio frame (LISTENING) {"frameNumber":3,"frameSize":160,"rms":"18.0","hexDump":"fa 7c 7c 7c 7b 7e fd fa 7b fd ff 7c 7d 7d 7e 79... (160 bytes total)"}
[DEBUG] [twilio-voice-stream] Incoming audio frame (LISTENING) {"frameNumber":2,"frameSize":160,"rms":"17.4","hexDump":"fe 7e 7e fc 7e 7e ff 7b 7e ff fc 7b 7d fd ff fa... (160 bytes total)"}
[DEBUG] [twilio-voice-stream] Incoming audio frame (LISTENING) {"frameNumber":1,"frameSize":160,"rms":"16.8","hexDump":"7c 7e fe fe 7c ff 7d ff 7d 7b 7d 7b 7d 7c fe 7e... (160 bytes total)"}
[INFO] [twilio-voice-stream] ElevenLabs REST streaming complete {"totalBytesProcessed":36320,"framesStreamed":228}
[DEBUG] [twilio-voice-stream] ElevenLabs REST stream complete {"totalBytesProcessed":36320,"framesStreamed":227}
[DEBUG] [twilio-voice-stream] ElevenLabs REST response received, processing stream
[ERROR] [twilio-voice-stream] ElevenLabs WebSocket streaming failed, attempting REST fallback {"error":"Invalid protocol value","stack":"SyntaxError: Invalid protocol value\n at new WebSocket (ext:deno_websocket/01_websocket.js:211:13)\n at AIVoiceSession.streamElevenLabsWebSocket (file:///tmp/user_fn_gnqqktmslswgjtvxfvdo_2c5e4c84-316c-4bd2-9c06-48a5d8229532_542/source/supabase/functions/twilio-voice-stream/index.ts:784:16)\n at AIVoiceSession.speakResponseFixed (file:///tmp/user_fn_gnqqktmslswgjtvxfvdo_2c5e4c84-316c-4bd2-9c06-48a5d8229532_542/source/supabase/functions/twilio-voice-stream/index.ts:757:18)\n at AIVoiceSession.speakResponse (file:///tmp/user_fn_gnqqktmslswgjtvxfvdo_2c5e4c84-316c-4bd2-9c06-48a5d8229532_542/source/supabase/functions/twilio-voice-stream/index.ts:739:16)\n at AIVoiceSession.processUserSpeech (file:///tmp/user_fn_gnqqktmslswgjtvxfvdo_2c5e4c84-316c-4bd2-9c06-48a5d8229532_542/source/supabase/functions/twilio-voice-stream/index.ts:599:20)\n at eventLoopTick (ext:core/01_core.js:175:7)\n at async AIVoiceSession.handleListeningState (file:///tmp/user_fn_gnqqktmslswgjtvxfvdo_2c5e4c84-316c-4bd2-9c06-48a5d8229532_542/source/supabase/functions/twilio-voice-stream/index.ts:488:11)\n at async AIVoiceSession.processAudioFrame (file:///tmp/user_fn_gnqqktmslswgjtvxfvdo_2c5e4c84-316c-4bd2-9c06-48a5d8229532_542/source/supabase/functions/twilio-voice-stream/index.ts:449:9)\n at async AIVoiceSession.handleTwilioMessage (file:///tmp/user_fn_gnqqktmslswgjtvxfvdo_2c5e4c84-316c-4bd2-9c06-48a5d8229532_542/source/supabase/functions/twilio-voice-stream/index.ts:427:9)\n at async WebSocket.ws.onmessage (file:///tmp/user_fn_gnqqktmslswgjtvxfvdo_2c5e4c84-316c-4bd2-9c06-48a5d8229532_542/source/supabase/functions/twilio-voice-stream/index.ts:295:9)"}
[INFO] [twilio-voice-stream] Using ElevenLabs REST API fallback {"textLength":34,"voiceId":"Xb7hH8MSUJpSbSDYk0k2"}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] Skipping direct frame send {"hasStreamSid":true,"isClosed":true,"wsReadyState":3,"isElevenLabsStreaming":false,"pendingCleanup":false}
[DEBUG] [twilio-voice-stream] ElevenLabs REST response received, processing stream
[INFO] [twilio-voice-stream] Performing actual cleanup {"wasDeferred":true}
[INFO] [twilio-voice-stream] Session metrics {"duration":12301,"framesReceived":367,"framesSent":424,"conversationTurns":1,"avgFramesPerSecond":29.83497276644175}
[INFO] [twilio-voice-stream] 🔌 ElevenLabs WebSocket closed {"code":1005,"reason":"No reason provided","wasClean":true,"framesReceived":0,"wasConnected":true,"hadError":false,"hasReceivedACK":false,"protocol":"xi_api_key authentication in first message","authFailure":"No","possibleIssues":["Verify API key is valid","Check voiceId exists","Ensure xi_api_key is included in first message","Verify proper message format"]}
[INFO] [twilio-voice-stream] Performing deferred cleanup after ElevenLabs close
[ERROR] [twilio-voice-stream] ⚠️ WebSocket closed without receiving ACK {"possibleCause":"Authentication failed or invalid initialization message"}
[INFO] [twilio-voice-stream] Using ElevenLabs REST API fallback {"textLength":34,"voiceId":"Xb7hH8MSUJpSbSDYk0k2"}
[ERROR] [twilio-voice-stream] ElevenLabs WebSocket streaming failed, attempting REST fallback {"error":"No ACK received after 5s - check initialization message","stack":"Error: No ACK received after 5s - check initialization message\n at file:///tmp/user_fn_gnqqktmslswgjtvxfvdo_2c5e4c84-316c-4bd2-9c06-48a5d8229532_548/source/supabase/functions/twilio-voice-stream/index.ts:1068:18\n at callback (ext:deno_web/02_timers.js:58:7)\n at eventLoopTick (ext:core/01_core.js:210:13)"}
[ERROR] [twilio-voice-stream] ⏱️ ElevenLabs ACK timeout after connection {"readyState":1,"hasReceivedACK":false,"framesReceived":0,"possibleCauses":["Invalid initialization message format","Authentication failed despite connection","Invalid voiceId or model_id"]}
[INFO] [twilio-voice-stream] WebSocket connection closed
[INFO] [twilio-voice-stream] Cleanup requested {"hasGreeted":true,"conversationLength":2,"isReady":true,"sessionDuration":8364,"totalFramesSent":424,"totalFramesReceived":367,"isElevenLabsStreaming":true}
[INFO] [twilio-voice-stream] Deferring cleanup - ElevenLabs is still streaming audio
[INFO] [twilio-voice-stream] Deferring cleanup - ElevenLabs is still streaming audio
[INFO] [twilio-voice-stream] Call ended - stop event received
[INFO] [twilio-voice-stream] Cleanup requested {"hasGreeted":true,"conversationLength":2,"isReady":true,"sessionDuration":7356,"totalFramesSent":424,"totalFramesReceived":367,"isElevenLabsStreaming":true}
[DEBUG] [twilio-voice-stream] 🔚 PHASE 3 queued: Close message {"text":"empty string for EOS","phase":"3 of 3"}
[DEBUG] [twilio-voice-stream] 📝 PHASE 2 queued: Text message {"textLength":34,"try_trigger_generation":true,"phase":"2 of 3"}
[INFO] [twilio-voice-stream] ✅ ElevenLabs WebSocket connected, implementing 3-phase protocol
[INFO] [twilio-voice-stream] 📤 PHASE 1: Sending initialization message with xi_api_key {"message":"xi_api_key, text=\" \", voice_settings, generation_config, model_id, output_format","protocol":"Fixed ElevenLabs 3-phase protocol with authentication","phase":"1 of 3","hasApiKey":true}
[INFO] [twilio-voice-stream] Starting ElevenLabs TTS with WebSocket streaming {"textLength":34,"voiceId":"Xb7hH8MSUJpSbSDYk0k2","codec":"mulaw","frameSize":160,"streamingMode":"websocket"}
[DEBUG] [twilio-voice-stream] OpenAI response received {"hasResponse":true,"responseLength":34,"usage":{"prompt_tokens":48,"completion_tokens":9,"total_tokens":57,"prompt_tokens_details":{"cached_tokens":0,"audio_tokens":0},"completion_tokens_details":{"reasoning_tokens":0,"audio_tokens":0,"accepted_prediction_tokens":0,"rejected_prediction_tokens":0}}}
[INFO] [twilio-voice-stream] Connecting to ElevenLabs WebSocket with xi_api_key in first message {"voiceId":"Xb7hH8MSUJpSbSDYk0k2","url":"wss://api.elevenlabs.io/v1/text-to-speech/Xb7hH8MSUJpSbSDYk0k2/stream-input?model_id=eleven_turbo_v2_5&output_format=ulaw_8000&optimize_streaming_latency=3","protocol":"xi_api_key authentication in first message (as required by ElevenLabs)","textLength":34,"implementation":"Fixed authentication method per explicit ElevenLabs requirements"}
[INFO] [twilio-voice-stream] Transcription completed {"transcript":"You","transcriptLength":3}
[DEBUG] [twilio-voice-stream] OpenAI chat request {"model":"gpt-4o-mini","messageCount":2,"maxTokens":150,"temperature":0.7}
[DEBUG] [twilio-voice-stream] Whisper transcription result {"hasText":true,"textLength":3}
[DEBUG] [twilio-voice-stream] Starting Whisper transcription {"audioSize":5164,"model":"whisper-1"}
[INFO] [twilio-voice-stream] Processing user speech {"bufferLength":16,"durationMs":320}
[DEBUG] [twilio-voice-stream] Incoming audio frame (LISTENING) {"frameNumber":3,"frameSize":160,"rms":"14.9","hexDump":"ff 7d 7e 7e 7a 7d fe fe fc fd fe fe fc 7d fe 7d... (160 bytes total)"}
[DEBUG] [twilio-voice-stream] Incoming audio frame (LISTENING) {"frameNumber":2,"frameSize":160,"rms":"16.9","hexDump":"fe 7e fe 7a 7c fc fe f9 fe 7e 7c 7d fe fd 7d fd... (160 bytes total)"}
[DEBUG] [twilio-voice-stream] Incoming audio frame (LISTENING) {"frameNumber":1,"frameSize":160,"rms":"15.9","hexDump":"fa fe 7e fd 7e fc 7d 7e fd 7d ff fd fd 7c 7d fa... (160 bytes total)"}
[INFO] [twilio-voice-stream] ElevenLabs REST streaming complete {"totalBytesProcessed":66080,"framesStreamed":414}
[DEBUG] [twilio-voice-stream] ElevenLabs REST stream complete {"totalBytesProcessed":66080,"framesStreamed":413}
[DEBUG] [twilio-voice-stream] ElevenLabs REST response received, processing stream
[INFO] [twilio-voice-stream] 🔌 ElevenLabs WebSocket closed {"code":1005,"reason":"No reason provided","wasClean":true,"framesReceived":0,"wasConnected":true,"hadError":false,"hasReceivedACK":false,"protocol":"xi_api_key authentication in first message","authFailure":"No","possibleIssues":["Verify API key is valid","Check voiceId exists","Ensure xi_api_key is included in first message","Verify proper message format"]}
[ERROR] [twilio-voice-stream] ⚠️ WebSocket closed without receiving ACK {"possibleCause":"Authentication failed or invalid initialization message"}
[INFO] [twilio-voice-stream] Using ElevenLabs REST API fallback {"textLength":69,"voiceId":"Xb7hH8MSUJpSbSDYk0k2"}
[ERROR] [twilio-voice-stream] ElevenLabs WebSocket streaming failed, attempting REST fallback {"error":"No ACK received after 5s - check initialization message","stack":"Error: No ACK received after 5s - check initialization message\n at file:///tmp/user_fn_gnqqktmslswgjtvxfvdo_2c5e4c84-316c-4bd2-9c06-48a5d8229532_548/source/supabase/functions/twilio-voice-stream/index.ts:1068:18\n at callback (ext:deno_web/02_timers.js:58:7)\n at eventLoopTick (ext:core/01_core.js:210:13)"}
[ERROR] [twilio-voice-stream] ⏱️ ElevenLabs ACK timeout after connection {"readyState":1,"hasReceivedACK":false,"framesReceived":0,"possibleCauses":["Invalid initialization message format","Authentication failed despite connection","Invalid voiceId or model_id"]}
[DEBUG] [twilio-voice-stream] Incoming audio frame (SPEAKING - barge-in detection) {"frameNumber":2,"frameSize":160,"rms":"4.0","threshold":800}
[DEBUG] [twilio-voice-stream] Incoming audio frame (SPEAKING - barge-in detection) {"frameNumber":3,"frameSize":160,"rms":"4.0","threshold":800}
[DEBUG] [twilio-voice-stream] Incoming audio frame (SPEAKING - barge-in detection) {"frameNumber":1,"frameSize":160,"rms":"4.0","threshold":800}
[DEBUG] [twilio-voice-stream] 🔚 PHASE 3 queued: Close message {"text":"empty string for EOS","phase":"3 of 3"}
[INFO] [twilio-voice-stream] 📤 PHASE 1: Sending initialization message with xi_api_key {"message":"xi_api_key, text=\" \", voice_settings, generation_config, model_id, output_format","protocol":"Fixed ElevenLabs 3-phase protocol with authentication","phase":"1 of 3","hasApiKey":true}
[INFO] [twilio-voice-stream] ✅ ElevenLabs WebSocket connected, implementing 3-phase protocol
[DEBUG] [twilio-voice-stream] 📝 PHASE 2 queued: Text message {"textLength":69,"try_trigger_generation":true,"phase":"2 of 3"}
[INFO] [twilio-voice-stream] Connecting to ElevenLabs WebSocket with xi_api_key in first message {"voiceId":"Xb7hH8MSUJpSbSDYk0k2","url":"wss://api.elevenlabs.io/v1/text-to-speech/Xb7hH8MSUJpSbSDYk0k2/stream-input?model_id=eleven_turbo_v2_5&output_format=ulaw_8000&optimize_streaming_latency=3","protocol":"xi_api_key authentication in first message (as required by ElevenLabs)","textLength":69,"implementation":"Fixed authentication method per explicit ElevenLabs requirements"}
[DEBUG] [twilio-voice-stream] Buffer warmup complete {"framesSent":10}
[INFO] [twilio-voice-stream] Starting greeting {"streamSid":"MZ45425a28e7df0c5afcc9ce4869cdd04d","greetingLength":0,"businessName":"this business"}
[INFO] [twilio-voice-stream] Starting ElevenLabs TTS with WebSocket streaming {"textLength":69,"voiceId":"Xb7hH8MSUJpSbSDYk0k2","codec":"mulaw","frameSize":160,"streamingMode":"websocket"}
[INFO] [twilio-voice-stream] ✅ FORCED codec configuration to μ-law for optimal audio quality {"codec":"mulaw","frameSize":160,"framesPerSecond":50,"durationPerFrame":20,"note":"Outbound codec explicitly forced to μ-law for ElevenLabs compatibility"}
[INFO] [twilio-voice-stream] ✅ Codec set to μ-law {"codec":"mulaw","frameSize":160,"bytesPerFrame":160}
[DEBUG] [twilio-voice-stream] Using μ-law silence pattern {"fillValue":"0xFF","frameSize":160}
[DEBUG] [twilio-voice-stream] Starting buffer warmup {"codec":"mulaw","frameSize":160,"warmupFrames":10,"warmupDurationMs":200}
[DEBUG] [twilio-voice-stream] Full start event received {"startEvent":{"accountSid":"ACe6e513d70609f6d6376a80db0b4214d5","streamSid":"MZ45425a28e7df0c5afcc9ce4869cdd04d","callSid":"CA2227053149221c106c7fa09e4d3d8cfe","tracks":["inbound"],"mediaFormat":{"encoding":"audio/x-mulaw","sampleRate":8000,"channels":1},"customParameters":{"to":"+19194203058","phoneNumber":"+19169450065","businessName":"this business","from":"+19169450065"}}}
[DEBUG] [twilio-voice-stream] Detected encoding type {"encoding":"audio/x-mulaw","originalEncoding":"audio/x-mulaw"}
[INFO] [twilio-voice-stream] StreamSid captured {"streamSid":"MZ45425a28e7df0c5afcc9ce4869cdd04d"}
[INFO] [twilio-voice-stream] Media format negotiated {"mediaFormat":{"encoding":"audio/x-mulaw","sampleRate":8000,"channels":1},"encoding":"audio/x-mulaw","sampleRate":8000,"channels":1}
[INFO] [twilio-voice-stream] Connected to Twilio WebSocket - waiting for start event
[INFO] [twilio-voice-stream] Call started {"streamSid":"MZ45425a28e7df0c5afcc9ce4869cdd04d","callSid":"CA2227053149221c106c7fa09e4d3d8cfe"}
[INFO] [twilio-voice-stream] AIVoiceSession initialized successfully {"tenantId":"","businessName":"this business","voiceId":"Xb7hH8MSUJpSbSDYk0k2","greetingLength":0,"hasOpenAIKey":true,"hasElevenLabsKey":true,"maxSessionDuration":"150s (Free) / 400s (Pro)","features":["WebSocket streaming","Barge-in detection","VAD with 500ms silence","Database-driven prompts","Session timeout protection"]}
[INFO] [twilio-voice-stream] WebSocket connection established
[INFO] [twilio-voice-stream] Twilio WebSocket connection request {"tenantId":"","businessName":"this business","voiceId":"Xb7hH8MSUJpSbSDYk0k2","greetingProvided":false,"headers":{"host":"edge-runtime.supabase.com","origin":null,"userAgent":"Twilio.TmeWs/1.0"},"production":true,"authRequired":false}
Listening on http://localhost:9999/